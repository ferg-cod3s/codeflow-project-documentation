name: Documentation Quality

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'
        continue-on-error: true

  link-checker:
    name: Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress '**/*.md' '**/*.html' --exclude-mail
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  spellcheck:
    name: Spell Checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check spelling
        uses: streetsidesoftware/cspell-action@v6
        with:
          files: '**/*.md'
          config: '.cspell.json'
          inline: warning
        continue-on-error: true

  validate-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking for required documentation files..."
          required_files=(
            "README.md"
            "docs/PRD.md"
            "docs/research-report.md"
            "docs/architecture.md"
            "docs/development.md"
          )

          missing_files=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              missing_files=$((missing_files + 1))
            else
              echo "✅ Found: $file"
            fi
          done

          if [ $missing_files -gt 0 ]; then
            echo "Error: $missing_files required file(s) missing"
            exit 1
          fi

          echo "All required files present!"

      - name: Validate markdown frontmatter
        run: |
          echo "Validating frontmatter in documentation files..."

          # Check PRD has proper frontmatter
          if ! grep -q "^---" docs/PRD.md; then
            echo "❌ docs/PRD.md missing frontmatter"
            exit 1
          fi

          echo "✅ Frontmatter validation passed"

      - name: Check for TODO items
        run: |
          echo "Checking for incomplete TODO items..."

          # Find all unchecked checkboxes in markdown files
          unchecked=$(grep -r "\[ \]" docs/ README.md || true)

          if [ -n "$unchecked" ]; then
            echo "Found unchecked TODO items:"
            echo "$unchecked"
            echo ""
            echo "ℹ️ This is informational only - not failing the build"
          else
            echo "✅ No unchecked TODO items found"
          fi

  documentation-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-checker, spellcheck, validate-structure]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Documentation Quality Check Summary"
          echo "=================================="
          echo "Markdown Lint: ${{ needs.markdown-lint.result }}"
          echo "Link Checker: ${{ needs.link-checker.result }}"
          echo "Spellcheck: ${{ needs.spellcheck.result }}"
          echo "Structure Validation: ${{ needs.validate-structure.result }}"

          if [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "❌ Critical validation failed"
            exit 1
          fi

          echo "✅ Documentation quality checks complete"
