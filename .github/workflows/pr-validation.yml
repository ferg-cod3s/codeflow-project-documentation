name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: [ main ]

jobs:
  pr-title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: changed-files
        run: |
          echo "Checking PR size..."

          # Get the base branch
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Count changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA...$HEAD_SHA | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

          # Count total lines changed
          LINES_CHANGED=$(git diff --shortstat $BASE_SHA...$HEAD_SHA | awk '{print $4+$6}')
          echo "lines_changed=${LINES_CHANGED:-0}" >> $GITHUB_OUTPUT

          echo "Files changed: $CHANGED_FILES"
          echo "Lines changed: ${LINES_CHANGED:-0}"

      - name: Comment on large PRs
        if: steps.changed-files.outputs.changed_files > 20
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è This PR is quite large (${{ steps.changed-files.outputs.changed_files }} files changed). Consider breaking it into smaller PRs for easier review.'
            })

  pr-description-check:
    name: Validate PR Description
    runs-on: ubuntu-latest

    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            if (!pr.body || pr.body.length < 50) {
              core.setFailed('PR description is too short. Please provide a detailed description of your changes.');
            }

            // Check for common sections
            const body = pr.body.toLowerCase();
            const hasSummary = body.includes('summary') || body.includes('## ');
            const hasChanges = body.includes('change') || body.includes('what');

            if (!hasSummary && !hasChanges) {
              core.warning('Consider adding a summary section to your PR description.');
            }

  documentation-impact:
    name: Check Documentation Impact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if documentation changed
        id: docs-changed
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Check if any .md files changed
          DOCS_CHANGED=$(git diff --name-only $BASE_SHA...$HEAD_SHA | grep '\.md$' || echo "")

          if [ -n "$DOCS_CHANGED" ]; then
            echo "has_docs_changes=true" >> $GITHUB_OUTPUT
            echo "Documentation files changed:"
            echo "$DOCS_CHANGED"
          else
            echo "has_docs_changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          fi

      - name: Add documentation label
        if: steps.docs-changed.outputs.has_docs_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['documentation']
            })

  auto-assign-reviewers:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Auto-assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            // You can customize this logic based on your team structure
            const author = context.payload.pull_request.user.login;

            console.log(`PR opened by: ${author}`);

            // Add a comment welcoming the contribution
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üëã Thank you for your contribution! A maintainer will review your PR shortly.'
            })

  pr-checklist:
    name: PR Checklist Validation
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Check if PR body contains checkboxes
            const hasCheckboxes = pr.body && (pr.body.includes('- [ ]') || pr.body.includes('- [x]'));

            if (!hasCheckboxes) {
              core.warning('Consider adding a checklist to your PR description to track completion of tasks.');
            } else {
              // Count unchecked items
              const unchecked = (pr.body.match(/- \[ \]/g) || []).length;
              const checked = (pr.body.match(/- \[x\]/gi) || []).length;

              console.log(`Checklist: ${checked}/${checked + unchecked} items completed`);

              if (unchecked > 0) {
                core.warning(`${unchecked} checklist item(s) still need to be completed.`);
              }
            }
